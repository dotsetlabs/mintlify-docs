---
title: Audit Trail
description: 'Complete activity logging and compliance'
---

# Audit Trail

Deadfall maintains a complete audit trail of all MCP server activity for compliance, forensics, and analysis.

## What's Logged

Every MCP tool call is recorded with:

| Field | Description |
|:------|:------------|
| `timestamp` | When the call occurred (UTC) |
| `server` | MCP server name |
| `tool` | Tool that was called |
| `arguments` | Tool arguments (redacted by default) |
| `result` | Success/failure status |
| `duration` | Execution time |
| `alert` | Associated alert, if any |

## Storage

### Default Location

```
~/.dotset/deadfall/activity.db
```

Activity is stored in SQLite for fast queries and portability.

### Custom Location

```yaml
logging:
  file: /var/log/deadfall/activity.db
```

### Retention

```yaml
logging:
  retention: 30d    # Keep 30 days
  max_size: 1GB     # Or until 1GB
```

Automatic cleanup runs daily. Old records are deleted, not archived.

## Querying

### CLI Queries

```bash
# Recent activity
deadfall query --last 1h

# Filter by server
deadfall query -s postgres-mcp --last 24h

# High severity only
deadfall query --severity high

# JSON output for scripting
deadfall query -o json | jq '.[] | select(.tool == "execute")'
```

### Direct SQL

For advanced queries, access the SQLite database directly:

```bash
sqlite3 ~/.dotset/deadfall/activity.db
```

```sql
-- Count by server
SELECT server, COUNT(*) as calls
FROM activity
WHERE timestamp > datetime('now', '-24 hours')
GROUP BY server;

-- Find high-volume periods
SELECT
  strftime('%Y-%m-%d %H:00', timestamp) as hour,
  COUNT(*) as calls
FROM activity
GROUP BY hour
ORDER BY calls DESC
LIMIT 10;
```

## Schema

```sql
CREATE TABLE activity (
  id TEXT PRIMARY KEY,
  timestamp DATETIME NOT NULL,
  server TEXT NOT NULL,
  tool TEXT NOT NULL,
  arguments TEXT,           -- JSON, redacted
  result TEXT,              -- success, error
  duration_ms INTEGER,
  error_message TEXT,

  -- Alert info (if triggered)
  alert_id TEXT,
  alert_type TEXT,
  alert_severity TEXT,

  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_timestamp ON activity(timestamp);
CREATE INDEX idx_server ON activity(server);
CREATE INDEX idx_alert ON activity(alert_id);
```

## PII Redaction

By default, sensitive data is redacted from logs:

```yaml
logging:
  redaction:
    enabled: true
    patterns:
      - password
      - secret
      - token
      - api_key
      - credential
    regex:
      - '\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b'  # Email
      - '\b\d{3}-\d{2}-\d{4}\b'  # SSN
```

**Before redaction:**
```json
{"sql": "SELECT * FROM users WHERE email = 'john@example.com'"}
```

**After redaction:**
```json
{"sql": "SELECT * FROM users WHERE email = '[REDACTED]'"}
```

### Disable Redaction

For debugging (not recommended in production):

```yaml
logging:
  redaction:
    enabled: false
```

## Export for Compliance

### Regular Exports

```bash
# Daily export
deadfall export --last 24h -o /compliance/$(date +%Y%m%d).json

# Monthly archive
deadfall export \
  --from "2024-01-01" \
  --to "2024-01-31" \
  --compress \
  -o /archive/2024-01.json.gz
```

### CEF Format for SIEM

```bash
deadfall export -f cef -o /var/log/deadfall.cef
```

### Compliance Reports

Generate summary reports:

```bash
# Activity summary
deadfall report summary --last 30d

# Alert report
deadfall report alerts --last 30d

# Export as PDF (requires wkhtmltopdf)
deadfall report summary --last 30d --format pdf -o report.pdf
```

## Integrity

### Checksums

Each log entry includes a SHA-256 checksum:

```sql
SELECT id, checksum FROM activity LIMIT 1;
-- evt_abc123, a1b2c3d4e5f6...
```

### Verification

```bash
# Verify log integrity
deadfall audit verify

# Output
✓ 15,234 records verified
✓ No tampering detected
✓ Checksums valid
```

## Forensics

### Incident Investigation

```bash
# Get all activity around an incident
deadfall query \
  --from "2024-01-15T14:00:00Z" \
  --to "2024-01-15T15:00:00Z" \
  -o json > incident.json

# Find related sessions
deadfall query --session sess_abc123

# Timeline view
deadfall timeline --from "2024-01-15T14:00:00Z" --duration 1h
```
