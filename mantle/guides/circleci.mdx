---
title: CircleCI
description: 'Protect your CircleCI pipelines'
---

# CircleCI Integration

Mantle integrates seamlessly with CircleCI to protect your build logs from secret exposure.

## Basic Setup

Add Mantle to your `.circleci/config.yml`:

```yaml
version: 2.1

jobs:
  test:
    docker:
      - image: cimg/node:20.0
    steps:
      - checkout
      - run:
          name: Install Mantle
          command: npm install -g @dotsetlabs/mantle
      - run:
          name: Install dependencies
          command: npm ci
      - run:
          name: Run tests with protection
          command: mantle run --mode redact -- npm test

workflows:
  main:
    jobs:
      - test
```

## Using Context Variables

CircleCI [contexts](https://circleci.com/docs/contexts/) provide secure environment variables:

```yaml
version: 2.1

jobs:
  deploy:
    docker:
      - image: cimg/node:20.0
    steps:
      - checkout
      - run:
          name: Install Mantle
          command: npm install -g @dotsetlabs/mantle
      - run:
          name: Deploy with protection
          command: mantle run --mode redact -- ./deploy.sh

workflows:
  main:
    jobs:
      - deploy:
          context:
            - aws-credentials
            - dotset-mantle
```

<Note>
Create a context with your secrets to share them across projects.
</Note>

## Using Project Environment Variables

Set variables in Project Settings â†’ Environment Variables:

```yaml
jobs:
  test:
    docker:
      - image: cimg/node:20.0
    environment:
      # These are automatically injected
      DATABASE_URL: $DATABASE_URL
      API_KEY: $API_KEY
    steps:
      - checkout
      - run: npm install -g @dotsetlabs/mantle
      - run: mantle run --mode redact -- npm test
```

## Using with .env Files

Create a `.env` file from environment variables:

```yaml
jobs:
  test:
    docker:
      - image: cimg/node:20.0
    steps:
      - checkout
      - run:
          name: Create .env file
          command: |
            echo "DATABASE_URL=$DATABASE_URL" >> .env
            echo "API_KEY=$API_KEY" >> .env
      - run:
          name: Install Mantle
          command: npm install -g @dotsetlabs/mantle
      - run:
          name: Run tests
          command: mantle run --mode redact -- npm test
```

## Caching Mantle Installation

Speed up your builds by caching npm global packages:

```yaml
version: 2.1

jobs:
  test:
    docker:
      - image: cimg/node:20.0
    steps:
      - checkout
      - restore_cache:
          keys:
            - npm-global-v1-{{ checksum "package-lock.json" }}
            - npm-global-v1-
      - run:
          name: Install Mantle
          command: npm install -g @dotsetlabs/mantle
      - save_cache:
          paths:
            - ~/.npm
          key: npm-global-v1-{{ checksum "package-lock.json" }}
      - run: npm ci
      - run: mantle run --mode redact -- npm test
```

## Complete Example

```yaml
version: 2.1

orbs:
  node: circleci/node@5.0

jobs:
  test:
    docker:
      - image: cimg/node:20.0
    steps:
      - checkout
      - node/install-packages
      - run:
          name: Install Mantle
          command: npm install -g @dotsetlabs/mantle
      - run:
          name: Run tests with protection
          command: mantle run --mode redact -- npm test

  deploy:
    docker:
      - image: cimg/node:20.0
    steps:
      - checkout
      - run:
          name: Install Mantle
          command: npm install -g @dotsetlabs/mantle
      - run:
          name: Deploy with protection
          command: mantle run --mode redact -- ./scripts/deploy.sh

workflows:
  build-and-deploy:
    jobs:
      - test
      - deploy:
          requires:
            - test
          context:
            - aws-credentials
          filters:
            branches:
              only: main
```
