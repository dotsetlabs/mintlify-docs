---
title: Pattern Learning
description: 'How Shell Guardian learns from your decisions to suggest policy rules'
---

# Pattern Learning

Shell Guardian learns from your approval decisions and suggests policy rules to automate common patterns. Over time, it reduces approval fatigue by understanding your preferences.

## How Learning Works

```
1. You approve/deny commands
       â†“
2. Shell Guardian records decisions with context
       â†“
3. Patterns are extracted and analyzed
       â†“
4. Rules are suggested when patterns emerge
       â†“
5. You accept or dismiss suggestions
```

## Recording Decisions

Every approval decision is recorded:

```typescript
interface ApprovalRecord {
  id: string;
  command: string;
  normalizedPattern: string;  // "rm -r -f <directory>"
  decision: 'approved' | 'denied' | 'timeout';
  timestamp: Date;
  context: {
    projectType: string;
    gitRepo: boolean;
    hasUncommittedChanges: boolean;
    environment: string;
    cwd: string;
  };
  responseTimeMs: number;
  chosenAlternative?: string;
  sessionGrant?: { scope: string; duration: string };
}
```

## Pattern Extraction

Commands are normalized into patterns:

| Original Command | Normalized Pattern |
|:-----------------|:-------------------|
| `rm -rf node_modules` | `rm -r -f <directory>` |
| `rm -rf /home/user/build` | `rm -r -f <path>` |
| `npm run dev` | `npm run <script>` |
| `git push origin main` | `git push <remote> <branch>` |
| `chmod 755 script.sh` | `chmod <mode> <file>` |

### Normalization Rules

```
1. Expand short flags: -rf â†’ -r -f
2. Sort flags alphabetically: -fr â†’ -f -r
3. Replace paths with <path> or <directory>
4. Replace arguments with <arg>
5. Preserve command structure
```

## Learned Patterns

After enough decisions, patterns emerge:

```typescript
interface LearnedPattern {
  pattern: string;           // "npm run <script>"
  frequency: number;         // 47
  approvalRate: number;      // 0.98 (98%)
  denialRate: number;        // 0.02 (2%)
  timeoutRate: number;       // 0.00 (0%)
  avgDecisionTimeMs: number; // 1200
  contextSummary: {
    projectTypes: { "nodejs": 45, "unknown": 2 };
    environments: { "development": 47 };
    alternativeChoiceRate: 0.02;
  };
}
```

## Rule Suggestions

When patterns show consistent behavior, Shell Guardian suggests rules:

```
ðŸ’¡ Rule Suggestion
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  Pattern: npm run *
  Suggested action: ALLOW

  Confidence: 94%
  Based on: 47 approvals, 1 denial

  Analysis:
    â€¢ Approved 98% of the time
    â€¢ Average decision time: 1.2s (quick decisions)
    â€¢ Primarily in Node.js projects
    â€¢ Always in development environment

  Rule that would be created:
    - pattern: "npm run *"
      action: allow
      reason: "Consistently approved npm scripts"

  [a] Accept   [d] Dismiss   [c] Customize
```

## Suggestion Criteria

Rules are suggested when:

| Criteria | For Allow Rule | For Deny Rule |
|:---------|:---------------|:--------------|
| Minimum occurrences | â‰¥5 | â‰¥5 |
| Approval rate | â‰¥90% | â‰¤10% |
| Minimum confidence | â‰¥70% | â‰¥70% |
| No recent denials | Last 30 days | Last 30 days |

## Confidence Calculation

Confidence is based on multiple factors:

```
Base confidence from rate:     40%
Sample size bonus:             up to 30%
Consistency bonus:             up to 10%
Quick decision bonus:          up to 10%
Alternative choice penalty:    -20% if >30%
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Maximum:                       100%
```

### Example

```
Pattern: "npm test"

Factors:
  Approval rate: 98% â†’ 0.98 Ã— 0.4 = 0.39
  Sample size: 25 occurrences â†’ min(25/20, 0.3) = 0.30
  Consistency: 0% timeouts â†’ 0.10
  Quick decisions: 1.5s avg â†’ 0.10
  Alternative choices: 2% â†’ no penalty

Total: 0.39 + 0.30 + 0.10 + 0.10 = 0.89 (89%)
```

## Accepting Suggestions

When you accept a suggestion:

```bash
[a] Accept

âœ“ Rule added to ~/.config/tollgate/guard.yaml:

rules:
  - pattern: "npm run *"
    action: allow
    reason: "Consistently approved npm scripts"
    # Added by learning system on 2024-01-15
    # Confidence: 94% based on 47 occurrences
```

## Dismissing Suggestions

When you dismiss a suggestion:

```bash
[d] Dismiss

Suggestion dismissed. It won't be shown again unless:
  â€¢ Pattern behavior changes significantly
  â€¢ 30 days have passed
```

## Customizing Suggestions

When you customize:

```bash
[c] Customize

Current suggestion:
  pattern: "npm run *"
  action: allow

Customize:
  [1] Change action (allow â†’ prompt)
  [2] Add conditions (project type, environment)
  [3] Narrow pattern ("npm run dev" only)
  [4] Broaden pattern ("npm *")

> 2

Add conditions:
  [x] Only in Node.js projects
  [ ] Only in development environment
  [ ] Only in git repositories

âœ“ Rule added with conditions:
  - pattern: "npm run *"
    action: allow
    conditions:
      projectTypes: ["nodejs"]
```

## Learning Statistics

View your learning statistics:

```bash
tollgate guard stats --learning

Learning Statistics
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  Total decisions recorded: 1,247
  Unique patterns: 89

  Decision breakdown:
    Approved: 1,089 (87%)
    Denied: 142 (11%)
    Timeout: 16 (2%)

  Suggestions:
    Generated: 23
    Accepted: 18
    Dismissed: 5
    Pending: 0

  Top patterns:
    npm run *        â†’ 156 occurrences (99% approved)
    git status       â†’ 89 occurrences (100% approved)
    rm -rf <dir>     â†’ 67 occurrences (78% approved)

  Time saved by rules: ~4.2 hours
```

## Exporting Rules

Export suggestions as YAML:

```bash
tollgate guard suggest --export

# Auto-generated rules from Shell Guardian learning
# Generated: 2024-01-15T10:30:00Z

rules:
  - pattern: "npm run *"
    action: allow
    reason: "Automatically approved 98% of the time"
    # Confidence: 94%
    # Based on 47 occurrences

  - pattern: "git status"
    action: allow
    reason: "Automatically approved 100% of the time"
    # Confidence: 97%
    # Based on 89 occurrences

  - pattern: "rm -rf /"
    action: deny
    reason: "Consistently denied (100% denial rate)"
    # Confidence: 99%
    # Based on 12 occurrences
```

## Refinement Opportunities

Shell Guardian identifies patterns that could be improved:

```
Refinement Opportunities
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  Pattern: rm -rf <directory>

  Issues:
    â€¢ Users chose alternatives 45% of the time
    â€¢ Behavior varies by project type

  Suggestions:
    â€¢ Consider using 'trash' as default instead of 'rm'
    â€¢ Create project-specific rules:
      - In Node.js: Allow for node_modules
      - In Python: Allow for __pycache__
      - Otherwise: Prompt
```

## Data Storage

Learning data is stored locally:

```
~/.config/tollgate/
â”œâ”€â”€ guard.yaml          # Configuration
â””â”€â”€ learning.json       # Learning data
```

### Data Structure

```json
{
  "version": "1.0",
  "records": [...],
  "patterns": [...],
  "suggestions": {
    "generated": [...],
    "accepted": [...],
    "dismissed": [...]
  },
  "stats": {
    "totalDecisions": 1247,
    "uniquePatterns": 89,
    "oldestRecord": "2024-01-01T00:00:00Z",
    "newestRecord": "2024-01-15T10:30:00Z"
  }
}
```

## Privacy

Learning data stays local:
- No data sent to external servers
- All analysis happens on your machine
- Data can be deleted anytime

```bash
# Clear all learning data
tollgate guard learn --clear

# Clear data older than 30 days
tollgate guard learn --prune --days 30
```

## Configuration

```yaml
learning:
  enabled: true

  # Suggestion thresholds
  minOccurrences: 5
  minApprovalRateForAllow: 0.90
  maxApprovalRateForDeny: 0.10
  minConfidence: 0.70

  # Data retention
  maxRecordAgeDays: 90
  maxRecords: 10000

  # Storage location
  storagePath: "~/.config/tollgate/learning.json"

  # Notification
  notifyOnSuggestion: true
  suggestionCheckInterval: "1d"
```

## Next Steps

- [Shell Guardian Overview](/tollgate/concepts/shell-guardian) - Main documentation
- [Policies](/tollgate/concepts/policies) - Understanding policy configuration
- [Sessions](/tollgate/concepts/sessions) - Time-based approval grants
