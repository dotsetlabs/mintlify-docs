---
title: Context-Aware Risk
description: 'How project, git, and environment context affects risk assessment'
---

# Context-Aware Risk Assessment

Shell Guardian doesn't evaluate commands in isolation. The same command can be safe or dangerous depending on context. The context system gathers information about your environment to make smarter risk decisions.

## Context Layers

Shell Guardian analyzes four context layers:

| Layer | What It Detects | Risk Impact |
|:------|:----------------|:------------|
| **Project** | Project type, regenerable paths | Can reduce risk |
| **Git** | Repo status, uncommitted changes | Can increase risk |
| **Directory** | Path sensitivity | Can increase risk |
| **Environment** | Dev/CI/Production | Can increase risk |

## Project Context

Shell Guardian detects your project type and understands which directories are regenerable.

### Supported Project Types

| Project Type | Detection | Regenerable Directories |
|:-------------|:----------|:------------------------|
| Node.js | `package.json` | `node_modules`, `dist`, `build` |
| Python | `pyproject.toml`, `setup.py` | `.venv`, `__pycache__`, `.tox` |
| Go | `go.mod` | `vendor` (if in go.sum) |
| Rust | `Cargo.toml` | `target` |
| Ruby | `Gemfile` | `vendor/bundle` |
| Java | `pom.xml`, `build.gradle` | `target`, `build` |
| .NET | `*.csproj` | `bin`, `obj` |
| PHP | `composer.json` | `vendor` |

### Regenerable Path Detection

When a command targets a regenerable directory, risk is reduced:

```bash
# Without context awareness
rm -rf node_modules  → destructive

# With context awareness (Node.js project)
rm -rf node_modules  → write (regenerable via npm install)
```

This works because Shell Guardian knows:
1. You're in a Node.js project (detected `package.json`)
2. `node_modules` can be recreated with `npm install`
3. The risk can be mitigated

### Configuration

```yaml
# Override or add regenerable patterns
context:
  regenerablePaths:
    - "node_modules"
    - "dist"
    - "build"
    - ".cache"
    - "coverage"
```

## Git Context

Shell Guardian integrates with git to understand version control status.

### What Git Context Detects

| Property | Risk Impact |
|:---------|:------------|
| `isRepo` | Enables git-based recovery |
| `hasUncommittedChanges` | Increases risk (+50%) |
| `trackedFiles` | Can be recovered from git |
| `untrackedFiles` | Cannot be recovered |
| `branch` | Detects protected branches |

### Uncommitted Changes Warning

When you have uncommitted changes, risk is elevated:

```
⚠  Command Review Required
────────────────────────────────────────────────────────

  Command:
    git reset --hard HEAD

  Context:
    git repo • ⚠️ uncommitted changes (3 files)

  Risk Assessment:
    Level: ■ DESTRUCTIVE (elevated from write)
    Reason: Would discard uncommitted work
```

### Git Recovery Analysis

Shell Guardian knows which files can be recovered:

```
Reversibility:
  ↩️  partially-reversible (45%)

  Recoverable (git tracked):
    src/index.ts
    src/utils.ts

  Not recoverable (untracked):
    src/new-feature.ts
    test/new.test.ts

  How to undo: git checkout -- src/
```

### Configuration

```yaml
context:
  git:
    # Warn about operations on protected branches
    protectedBranches:
      - main
      - master
      - production

    # Elevate risk when uncommitted changes present
    uncommittedRiskMultiplier: 1.5
```

## Directory Context

Shell Guardian scores directory sensitivity to detect risky paths.

### Sensitivity Scoring

| Path Pattern | Sensitivity | Example |
|:-------------|:------------|:--------|
| System directories | 100 | `/etc`, `/usr`, `/bin` |
| Home directory root | 90 | `~`, `/home/user` |
| Config files | 80 | `~/.bashrc`, `~/.ssh` |
| Project root | 50 | Current working directory |
| Temp directories | 10 | `/tmp`, `~/.cache` |
| Regenerable | 10 | `node_modules`, `build` |

### Sensitive Path Detection

Commands targeting sensitive paths get elevated risk:

```bash
# Normal project directory
rm -rf build/  → write

# Home directory
rm -rf ~/  → dangerous (sensitivity: 90)

# System directory
rm -rf /etc/  → dangerous (sensitivity: 100)
```

### Configuration

```yaml
context:
  directory:
    # Add custom sensitive paths
    sensitivePaths:
      - "~/.aws"
      - "~/.kube"
      - "/var/www"

    # Add safe paths (lower sensitivity)
    safePaths:
      - "/tmp"
      - "~/.cache"
```

## Environment Context

Shell Guardian detects your deployment environment and adjusts risk accordingly.

### Environment Detection

| Environment | Detection Method | Risk Modifier |
|:------------|:-----------------|:--------------|
| Development | Default | None |
| CI | `CI`, `GITHUB_ACTIONS`, `GITLAB_CI` env vars | +1 level |
| Production | `NODE_ENV=production`, hostname patterns | +1 level |
| Container | `/.dockerenv`, cgroup detection | +1 level |
| SSH Session | `SSH_CLIENT`, `SSH_TTY` env vars | Warning |
| Root User | `uid=0` | Warning |

### Production Environment Elevation

In production, all risks are elevated by one level:

```bash
# Development
rm -rf /tmp/cache  → write

# Production (NODE_ENV=production)
rm -rf /tmp/cache  → destructive (elevated)
```

### Configuration

```yaml
context:
  environment:
    # Patterns that indicate production
    productionPatterns:
      - "prod-*"
      - "*.production.*"
      - "*-prod"

    # Always treat these hosts as production
    productionHosts:
      - "api.mycompany.com"
      - "db.mycompany.com"
```

## Risk Modifier Calculation

Shell Guardian combines all context factors into a risk modifier:

```
Final Risk = Base Risk × Context Modifier

Context Modifier =
  × Path Sensitivity Factor (0.1 - 1.0)
  × Environment Factor (1.0 - 1.5)
  × Git Factor (1.0 - 1.5)
```

### Example Calculations

**Safe scenario:**
```
Command: rm -rf node_modules
Base risk: destructive

Context:
  - Node.js project (regenerable) → ×0.3
  - Development environment → ×1.0
  - Git repo, no uncommitted changes → ×1.0

Final: destructive × 0.3 = write
```

**Risky scenario:**
```
Command: rm -rf src/
Base risk: destructive

Context:
  - Not regenerable → ×1.0
  - Production environment → ×1.5
  - Uncommitted changes → ×1.5

Final: destructive × 2.25 = dangerous
```

## Context Display in UI

The approval UI shows relevant context:

```
⚠  Command Review Required
────────────────────────────────────────────────────────

  Command:
    rm -rf src/components

  Context:
    Node.js project • git repo • uncommitted changes • development

  Risk Assessment:
    Level: ■ DESTRUCTIVE
    Reason: Recursive deletion with uncommitted changes
    Modifiers: +50% (uncommitted changes)
```

## Disabling Context

You can disable specific context layers:

```yaml
context:
  # Disable all context (not recommended)
  enabled: false

  # Or disable specific layers
  project:
    enabled: false
  git:
    enabled: false
  directory:
    enabled: false
  environment:
    enabled: false
```

## Next Steps

- [Shell Guardian Overview](/tollgate/concepts/shell-guardian) - Main Shell Guardian documentation
- [Reversibility](/tollgate/concepts/reversibility) - How context affects recovery analysis
- [Learning](/tollgate/concepts/learning) - Context is captured in learning data
