---
title: Shell Integration
description: 'Setting up Shell Guardian hooks for bash, zsh, and fish'
---

# Shell Integration

Shell Guardian integrates directly with your shell to intercept commands before execution. This guide covers setup for bash, zsh, and fish.

## Quick Setup

```bash
# Generate shell hook and add to config
tollgate guard init --shell bash >> ~/.bashrc
source ~/.bashrc

# Or for zsh
tollgate guard init --shell zsh >> ~/.zshrc
source ~/.zshrc

# Or for fish
tollgate guard init --shell fish >> ~/.config/fish/config.fish
source ~/.config/fish/config.fish
```

## Bash Integration

### Automatic Setup

```bash
tollgate guard init --shell bash >> ~/.bashrc
source ~/.bashrc
```

### Manual Setup

Add to `~/.bashrc`:

```bash
# Shell Guardian Integration
if command -v tollgate &> /dev/null; then
  # Use bash-preexec if available
  if [[ -n "${bash_preexec_imported:-}" ]]; then
    preexec() {
      tollgate guard check "$1" || return 1
    }
  else
    # Fallback to DEBUG trap
    __tollgate_preexec() {
      [[ -n "${COMP_LINE:-}" ]] && return
      [[ "${BASH_COMMAND}" == "${PROMPT_COMMAND:-}" ]] && return
      tollgate guard check "${BASH_COMMAND}" || return 1
    }
    trap '__tollgate_preexec' DEBUG
  fi
fi
```

### bash-preexec (Recommended)

For more reliable interception, install [bash-preexec](https://github.com/rcaloras/bash-preexec):

```bash
# Install bash-preexec
curl https://raw.githubusercontent.com/rcaloras/bash-preexec/master/bash-preexec.sh -o ~/.bash-preexec.sh
echo 'source ~/.bash-preexec.sh' >> ~/.bashrc

# Then add Shell Guardian
tollgate guard init --shell bash >> ~/.bashrc
source ~/.bashrc
```

## Zsh Integration

### Automatic Setup

```bash
tollgate guard init --shell zsh >> ~/.zshrc
source ~/.zshrc
```

### Manual Setup

Add to `~/.zshrc`:

```zsh
# Shell Guardian Integration
if (( $+commands[tollgate] )); then
  __tollgate_accept_line() {
    local cmd="${BUFFER}"
    if [[ -n "${cmd}" ]]; then
      tollgate guard check "${cmd}"
      if [[ $? -ne 0 ]]; then
        zle reset-prompt
        return 1
      fi
    fi
    zle .accept-line
  }
  zle -N accept-line __tollgate_accept_line
fi
```

### Oh-My-Zsh Plugin

For Oh-My-Zsh users, create a plugin:

```bash
mkdir -p ~/.oh-my-zsh/custom/plugins/tollgate
tollgate guard init --shell zsh > ~/.oh-my-zsh/custom/plugins/tollgate/tollgate.plugin.zsh
```

Then add to `~/.zshrc`:

```zsh
plugins=(... tollgate)
```

## Fish Integration

### Automatic Setup

```bash
tollgate guard init --shell fish >> ~/.config/fish/config.fish
source ~/.config/fish/config.fish
```

### Manual Setup

Add to `~/.config/fish/config.fish`:

```fish
# Shell Guardian Integration
if command -v tollgate &> /dev/null
  function __tollgate_preexec --on-event fish_preexec
    tollgate guard check "$argv"
    or return 1
  end
end
```

## Verifying Installation

After setup, verify Shell Guardian is active:

```bash
tollgate guard status

Shell Guardian Status
────────────────────────────────────────────────────────

  Status: Active ✓
  Shell: bash (via preexec)
  Config: ~/.config/tollgate/guard.yaml

  Statistics:
    Commands checked: 1,247
    Blocked: 23
    Prompted: 156
    Allowed: 1,068

  Active session grants: 3
    • npm run * (expires in 4m)
    • git status (expires in 12m)
    • ls * (session)
```

## Disabling Temporarily

### In Current Session

```bash
# Disable Shell Guardian
tollgate-guard-disable

# Commands now execute without checks

# Re-enable
tollgate-guard-enable
```

### For a Single Command

```bash
# Bypass Shell Guardian for one command
TOLLGATE_BYPASS=1 rm -rf node_modules
```

### In Configuration

```yaml
# ~/.config/tollgate/guard.yaml
enabled: false  # Globally disable
```

## Shell-Specific Notes

### Bash

| Feature | Support |
|:--------|:--------|
| Basic interception | DEBUG trap |
| Reliable interception | bash-preexec |
| History preservation | ✓ |
| Tab completion | ✓ |
| Subshells | Partial |

**Known Issues:**
- DEBUG trap may conflict with other tools using DEBUG
- Subshell commands (`$(cmd)`) not intercepted

### Zsh

| Feature | Support |
|:--------|:--------|
| Interception method | accept-line widget |
| History preservation | ✓ |
| Tab completion | ✓ |
| Subshells | Partial |

**Known Issues:**
- Some complex key bindings may need adjustment
- Compatibility with some zsh plugins

### Fish

| Feature | Support |
|:--------|:--------|
| Interception method | fish_preexec event |
| History preservation | ✓ |
| Tab completion | ✓ |
| Subshells | ✓ |

**Known Issues:**
- Requires fish 3.0+

## Advanced Configuration

### Exclude Patterns from Checking

```yaml
# ~/.config/tollgate/guard.yaml
shellIntegration:
  excludePatterns:
    - "^cd "          # Navigation
    - "^echo "        # Output
    - "^alias "       # Aliases
    - "^export "      # Environment
```

### Custom Shell Detection

```yaml
shellIntegration:
  shell: auto  # auto, bash, zsh, fish
  hookMethod: auto  # auto, preexec, trap, widget
```

### Performance Tuning

```yaml
shellIntegration:
  # Skip analysis for commands shorter than this
  minCommandLength: 3

  # Cache fast-path results
  cacheEnabled: true
  cacheTtlSeconds: 60

  # Timeout for guard check
  checkTimeoutMs: 5000
```

## Troubleshooting

### Shell Guardian Not Intercepting

1. **Verify installation:**
   ```bash
   tollgate guard status
   ```

2. **Check shell hook:**
   ```bash
   # For bash
   type preexec 2>/dev/null || echo "preexec not found"
   trap -p DEBUG

   # For zsh
   zle -l | grep accept-line

   # For fish
   functions __tollgate_preexec
   ```

3. **Reload shell config:**
   ```bash
   source ~/.bashrc  # or ~/.zshrc
   ```

### Commands Hanging

1. **Check timeout:**
   ```yaml
   shellIntegration:
     checkTimeoutMs: 3000  # Reduce timeout
   ```

2. **Verify TTY:**
   ```bash
   tty  # Should show /dev/tty* or /dev/pts/*
   ```

### Conflicts with Other Tools

Shell Guardian may conflict with:
- Other DEBUG trap users (bash)
- Other accept-line widgets (zsh)
- Terminal multiplexers (tmux/screen)

**Solution:** Adjust load order in shell config or use compatibility mode:

```yaml
shellIntegration:
  compatibilityMode: true
```

### Performance Issues

1. **Enable fast path:**
   ```yaml
   fastPath:
     enabled: true
     prefixes:
       - "ls"
       - "cd"
       - "pwd"
       # Add more common commands
   ```

2. **Reduce analysis scope:**
   ```yaml
   preview:
     enabled: false  # Disable preview generation

   alternatives:
     enabled: false  # Disable alternative lookup
   ```

## Uninstalling

### Remove Shell Hook

```bash
# Edit your shell config and remove the Shell Guardian section
nano ~/.bashrc  # or ~/.zshrc or ~/.config/fish/config.fish

# Or use the uninstall command
tollgate guard uninstall --shell bash
```

### Clear Data

```bash
# Remove learning data
rm ~/.config/tollgate/learning.json

# Remove all tollgate guard config
rm -rf ~/.config/tollgate/
```

## Next Steps

- [Shell Guardian Overview](/tollgate/concepts/shell-guardian) - Understanding Shell Guardian
- [Context System](/tollgate/concepts/context-system) - How environment affects risk
- [Learning](/tollgate/concepts/learning) - Pattern-based rule suggestions
