---
title: CI/CD Integration
description: Integrate Countersign verification into your CI/CD pipeline
---

# CI/CD Integration

Integrate Countersign into your CI/CD pipeline to automatically verify MCP server dependencies and sign your releases.

## Verification in CI

### GitHub Actions

```yaml
# .github/workflows/ci.yml
name: CI

on: [push, pull_request]

jobs:
  verify-dependencies:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Verify MCP servers
        run: |
          npm install -g @dotsetlabs/countersign
          countersign verify --from-package package.json --min-score 60
```

### GitLab CI

```yaml
# .gitlab-ci.yml
verify:
  image: node:20
  script:
    - npm ci
    - npm install -g @dotsetlabs/countersign
    - countersign verify --from-package package.json --min-score 60
```

### CircleCI

```yaml
# .circleci/config.yml
version: 2.1
jobs:
  verify:
    docker:
      - image: cimg/node:20.0
    steps:
      - checkout
      - run: npm ci
      - run: |
          npm install -g @dotsetlabs/countersign
          countersign verify --from-package package.json --min-score 60
```

## Signing Releases

### GitHub Actions with Workload Identity

```yaml
# .github/workflows/release.yml
name: Release

on:
  release:
    types: [created]

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      id-token: write    # Required for SIGSTORE
      contents: read

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install and build
        run: |
          npm ci
          npm run build
          npm test

      - name: Sign package
        run: npx @dotsetlabs/countersign sign --provider github

      - name: Verify signature
        run: npx @dotsetlabs/countersign verify .

      - name: Publish
        run: npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
```

### GitLab CI with OIDC

```yaml
# .gitlab-ci.yml
publish:
  image: node:20
  id_tokens:
    SIGSTORE_ID_TOKEN:
      aud: sigstore
  script:
    - npm ci
    - npm run build
    - npx @dotsetlabs/countersign sign --provider gitlab
    - npm publish --provenance
  only:
    - tags
```

## Verification Strategies

### Fail Fast

Block builds if any MCP server fails verification:

```yaml
- name: Verify (strict)
  run: countersign verify --from-package package.json --min-score 80
```

### Warn Only

Continue but warn about low-trust packages:

```yaml
- name: Verify (advisory)
  run: countersign verify --from-package package.json || echo "::warning::Some packages have low trust scores"
  continue-on-error: true
```

### Tiered Thresholds

Different thresholds for different environments:

```yaml
verify-dev:
  script: countersign verify --min-score 40 --from-package package.json

verify-prod:
  script: countersign verify --min-score 80 --from-package package.json
```

## Caching

Cache Countersign for faster builds:

### GitHub Actions

```yaml
- uses: actions/cache@v3
  with:
    path: ~/.npm
    key: ${{ runner.os }}-countersign-${{ hashFiles('**/package-lock.json') }}

- name: Install Countersign
  run: npm install -g @dotsetlabs/countersign
```

### GitLab CI

```yaml
verify:
  cache:
    paths:
      - node_modules/
  script:
    - npm install -g @dotsetlabs/countersign
    - countersign verify --from-package package.json
```

## Output Formats

### JSON for Processing

```yaml
- name: Verify and save report
  run: |
    countersign verify --output json --from-package package.json > verification-report.json

- uses: actions/upload-artifact@v3
  with:
    name: verification-report
    path: verification-report.json
```

### SARIF for GitHub Security

```yaml
- name: Verify to SARIF
  run: countersign verify --output sarif --from-package package.json > results.sarif

- uses: github/codeql-action/upload-sarif@v2
  with:
    sarif_file: results.sarif
```

## Environment Variables

| Variable | Description |
| -------- | ----------- |
| `COUNTERSIGN_MIN_SCORE` | Default minimum trust score |
| `COUNTERSIGN_TRUSTED_PUBLISHERS` | Comma-separated trusted publishers |
| `COUNTERSIGN_OUTPUT` | Default output format |
| `COUNTERSIGN_NO_COLOR` | Disable colored output |

```yaml
env:
  COUNTERSIGN_MIN_SCORE: 70
  COUNTERSIGN_TRUSTED_PUBLISHERS: anthropic,modelcontextprotocol
```

## Monorepo Support

For monorepos with multiple packages:

```yaml
- name: Verify all packages
  run: |
    for pkg in packages/*/package.json; do
      echo "Verifying $(dirname $pkg)..."
      countersign verify --from-package "$pkg" --min-score 60
    done
```

## Troubleshooting CI

### "Network timeout"

Increase timeout or add retry:

```yaml
- name: Verify with retry
  run: |
    for i in 1 2 3; do
      countersign verify --from-package package.json && break
      echo "Retry $i..."
      sleep 5
    done
```

### "Permission denied for id-token"

Add the permission to your workflow:

```yaml
permissions:
  id-token: write
```

### "No packages to verify"

Ensure your package.json has dependencies:

```yaml
- name: Check for MCP servers
  run: |
    if ! countersign verify --from-package package.json 2>&1 | grep -q "package"; then
      echo "No MCP servers found, skipping verification"
      exit 0
    fi
```
